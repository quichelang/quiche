# qtest Runner - Standalone test discovery and execution
# This version uses stdlib directly since scripts can't import runtime modules
#
# Usage: quiche qtest [pattern]

# Use stdlib directly since crate::quiche doesn't exist in standalone scripts
@extern(path="std::process::exit")
def exit(code: i32): pass

# ============================================================================
# Inlined TestResult and helpers (from qtest.qrs)
# Cannot import from quiche-runtime, so we inline the definitions
# ============================================================================

class TestResult(Enum):
    Passed = ()
    Failed = (String,)
    Skipped = (String,)

class TestSummary(Struct):
    total: usize
    passed: usize
    failed: usize
    skipped: usize
    failures: Vec[String]

def passed() -> TestResult:
    return TestResult.Passed

def failed(reason: String) -> TestResult:
    return TestResult.Failed(reason)

def create_test_summary() -> TestSummary:
    return TestSummary(
        total=0,
        passed=0,
        failed=0,
        skipped=0,
        failures=Vec.new()
    )

def record_result(summary: mutref[TestSummary], name: String, result: TestResult):
    summary.total = summary.total + 1
    match result:
        case TestResult.Passed:
            summary.passed = summary.passed + 1
            print(strcat("  [PASS] ", name))
        case TestResult.Failed(reason):
            summary.failed = summary.failed + 1
            summary.failures.push(strcat(name, ": ", reason))
            print(strcat("  [FAIL] ", name, ": ", reason))
        case TestResult.Skipped(reason):
            summary.skipped = summary.skipped + 1
            print(strcat("  [SKIP] ", name))

def print_summary(summary: ref[TestSummary]):
    print("")
    print("========================================")
    if summary.failed == 0:
        print(strcat("All ", summary.passed.to_string(), " tests passed"))
    else:
        print(strcat(summary.passed.to_string(), " passed, ", summary.failed.to_string(), " failed"))
    print("========================================")

# ============================================================================
# Self-Tests for qtest Framework
# ============================================================================

def test_qtest_passed_works() -> TestResult:
    result = passed()
    match result:
        case TestResult.Passed:
            return passed()
        case _:
            return failed("passed() did not return Passed")

def test_qtest_failed_works() -> TestResult:
    result = failed("test reason")
    match result:
        case TestResult.Failed(msg):
            if msg == "test reason":
                return passed()
            return failed("wrong message")
        case _:
            return failed("failed() did not return Failed")

def test_basic_math() -> TestResult:
    if 1 + 1 != 2:
        return failed("1 + 1 should equal 2")
    if 5 * 3 != 15:
        return failed("5 * 3 should equal 15")
    return passed()

def test_string_operations() -> TestResult:
    s: String = "hello".to_string()
    if s.len() != 5:
        return failed("string length should be 5")
    return passed()

# ============================================================================
# Main Test Runner
# ============================================================================

def main():
    print("")
    print("========================================")
    print("           qtest runner")
    print("========================================")
    print("")
    
    summary = create_test_summary()
    
    # Run built-in self-tests
    print("Running self-tests...")
    record_result(mutref(summary), "test_qtest_passed_works".to_string(), test_qtest_passed_works())
    record_result(mutref(summary), "test_qtest_failed_works".to_string(), test_qtest_failed_works())
    record_result(mutref(summary), "test_basic_math".to_string(), test_basic_math())
    record_result(mutref(summary), "test_string_operations".to_string(), test_string_operations())
    
    print_summary(ref(summary))
    
    if summary.failed > 0:
        exit(1)
